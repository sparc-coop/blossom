@page "/room/{roomId}"

@layout AppLayout

<TopBar OnToggleVoiceMode=ToggleVoiceMode Room="Room" />

<main>
    @foreach (var msg in messages)
    {
        <div class="message-container @(IsUserMessage(msg.Sender) ? "my-message" : "")">
            <MessageCard Message=@msg />
        </div>
    }
</main>

<ChatBar OnSendMessage=SendMessage VoiceMode=@voiceMode MessageSent=messageSent />

@inject ISparcAura Aura

@code {
    [Parameter] public required string RoomId { get; set; }

    BlossomUser? User { get; set; }
    private List<MessageEvent> messages = new List<MessageEvent>();
    private string currentMessage = "";
    private Room? Room { get; set; }

    bool voiceMode = false;
    bool messageSent = false;

    protected async override Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(RoomId))
        {
            throw new ArgumentException("RoomId must be provided", nameof(RoomId));
        }
        
        User = await Aura.UserInfo();
        Room = await Chats.GetRoomInfoAsync(RoomId);

        await GetMessagesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(RoomId))
            await GetMessagesAsync();
    }

    private async Task GetMessagesAsync()
    {
        messages = await Chats.GetMessagesAsync(RoomId);
    }

    private async Task SendMessage(string messageText)
    {
        if (!string.IsNullOrWhiteSpace(messageText))
        {
            var txnId = Guid.NewGuid().ToString();
            await Chats.SendMessageAsync(RoomId, "m.room.message", txnId, new(messageText));

            // currentMessage = "";
            await GetMessagesAsync();
        }
    }

    void ToggleVoiceMode(bool voiceBool)
    {
        voiceMode = voiceBool;
    }

    private bool IsUserMessage(string userId)
    {
        var matrixId = User?.Identities?.FirstOrDefault(x => x.Type == "Matrix")?.Id;
        if (userId == matrixId)
        {
            return true;
        }
        else
        {
            return false;
        }
    }
}